<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>üçΩ Autour de moi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; }
    h1 { font-size: 1.5rem; }
    label, select, button { margin: 0.5rem 0; display: block; }
    ul { padding-left: 0; }
    li { list-style: none; margin: 1rem 0; border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; }
    .button { display: inline-block; margin: 0.25rem 0.5rem 0.25rem 0; padding: 0.4rem 0.6rem; background: #eee; border-radius: 5px; text-decoration: none; }
  </style>
</head>
<body>
  <h1>üçΩ Trouver un lieu autour de moi</h1>
  <label for="category">Cat√©gorie :</label>
  <select id="category">
    <option value="restaurant">Restaurant</option>
    <option value="cafe">Caf√©</option>
    <option value="bakery">Boulangerie</option>
    <option value="pharmacy">Pharmacie</option>
    <option value="bar">Bar</option>
    <option value="fast_food">Fast Food</option>
    <option value="ice_cream">Glacier</option>
  </select>

  <label for="ville">ou entrer une ville :</label>
  <input type="text" id="ville" placeholder="Paris">

  <button onclick="rechercherListe()">üìÑ Afficher sous forme de liste</button>
  <button onclick="rechercherCarte()">üó∫ Afficher sur la carte</button>

  <div id="resultat"></div>

  <script>
    let mode = "liste";

    async function rechercherListe() {
      mode = "liste";
      await rechercher();
    }

    async function rechercherCarte() {
      mode = "carte";
      await rechercher();
    }

    async function rechercher() {
      const ville = document.getElementById("ville").value.trim();
      const cat = document.getElementById("category").value;
      const resultat = document.getElementById("resultat");
      resultat.innerHTML = "‚è≥ Recherche...";

      let coords = null;

      if (ville) {
        const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${ville}`);
        const json = await geo.json();
        if (json.length === 0) {
          resultat.innerHTML = "‚ùå Ville introuvable";
          return;
        }
        coords = { lat: json[0].lat, lon: json[0].lon };
      } else if (navigator.geolocation) {
        try {
          coords = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(pos =>
              resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
              reject
            );
          });
        } catch {
          resultat.innerHTML = "‚ùå Position non disponible";
          return;
        }
      } else {
        resultat.innerHTML = "‚ùå Activez la g√©olocalisation ou entrez une ville";
        return;
      }

      const pois = await fetchPlaces(coords, cat);
      if (!pois.length) {
        resultat.innerHTML = "‚ùå Aucun lieu trouv√©.";
        return;
      }

      if (mode === "carte") {
        const markers = pois.map(poi => `&marker=lat${poi.lat}lon${poi.lon}`);
        const url = `https://www.openstreetmap.org/export/embed.html?bbox=${pois[0].lon - 0.05},${pois[0].lat - 0.05},${pois[0].lon + 0.05},${pois[0].lat + 0.05}`;
        resultat.innerHTML = `<iframe width="100%" height="400" src="${url}" loading="lazy"></iframe>`;
      } else {
        const list = pois.map(poi => {
          const name = poi.tags.name || poi.tags["name:fr"] || "Nom inconnu";
          const street = poi.tags["addr:street"] || "";
          const number = poi.tags["addr:housenumber"] || "";
          const phone = poi.tags.phone || poi.tags["contact:phone"] || "";
          const cat = catToLabel(poi.tags);
          const lat = poi.lat;
          const lon = poi.lon;

          const itineraireURL = `gps.html?from=maPosition&to=${lat},${lon}`;

          const phoneHTML = phone ? `<a class="button" href="tel:${phone}">üìû ${phone}</a><br/>` : "";

          const vcard = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nORG:${cat}\nTEL:${phone || ""}\nADR:;;${number} ${street}\nEND:VCARD`;
          const vcardBlob = new Blob([vcard], { type: "text/vcard" });
          const vcardURL = URL.createObjectURL(vcardBlob);

          return `
            <li>
              <strong>${name === "Nom inconnu" ? cat : name}</strong><br/>
              Type : ${cat}<br/>
              Adresse : ${street} ${number}<br/>
              ${phoneHTML}
              <a href="${itineraireURL}" class="button">üß≠ Itin√©raire</a>
              <a href="${vcardURL}" download="${(name !== "Nom inconnu" ? name : cat).replace(/\s+/g, "_")}.vcf" class="button">üíæ Enregistrer le contact</a>
            </li>
          `;
        }).join("");

        resultat.innerHTML = `<ul>${list}</ul>`;
      }
    }

    async function fetchPlaces(coords, category) {
      const steps = [1000, 2000, 5000, 10000];
      for (const radius of steps) {
        const query = `[out:json];node(around:${radius},${coords.lat},${coords.lon})[amenity=${category}];out;`;
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.elements.length >= 10 || radius === 10000) {
          return data.elements;
        }
      }
      return [];
    }

    function catToLabel(tags) {
      if (tags.amenity) {
        const map = {
          restaurant: "Restaurant",
          cafe: "Caf√©",
          bakery: "Boulangerie",
          pharmacy: "Pharmacie",
          bar: "Bar",
          fast_food: "Fast Food",
          ice_cream: "Glacier"
        };
        return map[tags.amenity] || tags.amenity;
      }
      return "Lieu";
    }
  </script>
</body>
</html>

async function rechercherLieux() {
  const ville = document.getElementById("ville").value;
  const rayon = document.getElementById("rayon").value;
  const mode = document.getElementById("mode").value;
  const searchText = document.getElementById("searchText").value.trim().toLowerCase();
  const poiSelect = document.getElementById("poi").value;
  const resultat = document.getElementById("resultat");

  if (!ville) {
    alert("Veuillez entrer une ville.");
    return;
  }

  // Obtenir les coordonnées de la ville
  const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${ville}`);
  const dataVille = await response.json();
  if (!dataVille.length) {
    alert("Ville non trouvée.");
    return;
  }

  const lat = parseFloat(dataVille[0].lat);
  const lon = parseFloat(dataVille[0].lon);

  // Construire la requête Overpass
  let query = `
    [out:json][timeout:25];
    (
  `;

  if (searchText) {
    query += `
      node(around:${rayon},${lat},${lon})[name];
      node(around:${rayon},${lat},${lon})[brand];
    `;
  } else {
    const [key, value] = poiSelect.split("=");
    query += `
      node(around:${rayon},${lat},${lon})[${key}=${value}];
    `;
  }

  query += `
    );
    out center;
  `;

  const overpassURL = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
  const data = await fetch(overpassURL).then(r => r.json());

  // Filtrage local si recherche texte précisée
  if (searchText) {
    data.elements = data.elements.filter(el => {
      const name = el.tags?.name?.toLowerCase() || "";
      const brand = el.tags?.brand?.toLowerCase() || "";
      return name.includes(searchText) || brand.includes(searchText);
    });
  }

  if (!data.elements.length) {
    resultat.innerHTML = "Aucun lieu trouvé.";
    return;
  }

  // Calcul des distances et tri
  data.elements.forEach(el => {
    const elLat = el.lat || el.center?.lat;
    const elLon = el.lon || el.center?.lon;
    el._distance = elLat && elLon ? haversine(lat, lon, elLat, elLon) : Infinity;
  });
  data.elements.sort((a, b) => a._distance - b._distance);

  if (mode === "liste") {
    renderPlaces(data.elements, lat, lon);
  } else {
    afficherCarte(data.elements, lat, lon);
  }
}

// Fonction de calcul de distance (Haversine)
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI / 180;
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δφ = toRad(lat2 - lat1);
  const Δλ = toRad(lon2 - lon1);

  const a = Math.sin(Δφ / 2) ** 2 +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c;
}
